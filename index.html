<!DOCTYPE html>
<html>
<head>
    <title>Gemini ë©€í‹° ì±„íŒ…ë°©</title>
    <style>
        body { 
            margin: 0; 
            padding-bottom: 70px; 
            font-family: sans-serif; 
            background-color: #f7f7f7;
        }
        header {
            background-color: #3f51b5;
            color: white;
            padding: 15px;
            text-align: center;
        }
        #main-content {
            padding: 20px;
        }
        #messages { 
            margin: 0; 
            padding: 10px; 
            list-style-type: none; 
        }
        #messages li { 
            margin-bottom: 10px; 
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            line-height: 1.4;
        }
        .chat-message-time {
            color: gray; 
            font-size: 0.75em;
            margin-left: 5px;
        }
        .chatbot-message {
            background-color: #e8eaf6; 
            border-left: 4px solid #3f51b5; 
        }
        .chatbot-nickname {
            color: #3f51b5; 
            font-weight: bold;
        }
        .user-nickname {
            font-weight: bold;
            color: #333;
        }
        #chat-form {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: #ffffff;
            padding: 10px;
            box-sizing: border-box;
            border-top: 1px solid #ddd;
            display: flex;
        }
        #chat-input {
            flex-grow: 1;
            padding: 10px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #chat-form button, .btn {
            padding: 10px 15px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover, .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* ë°© ëª©ë¡ ìŠ¤íƒ€ì¼ */
        .room-item {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            cursor: pointer;
            background-color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .room-item:hover {
            background-color: #eee;
        }
        .room-info {
            font-weight: bold;
        }
        .room-status {
            font-size: 0.9em;
            color: #555;
        }
    </style>
</head>
<body>
    <header>
        <div id="room-header">
            <span id="room-title">Gemini ë©€í‹° ì±„íŒ…ë°© ë¡œë¹„</span> 
            <span id="user-count-area" style="float: right; font-size: 0.9em;"></span>
        </div>
    </header>

    <div id="main-content">
        <button id="create-room-btn" class="btn">ë°© ë§Œë“¤ê¸°</button>
        <h3>í˜„ì¬ í™œì„±í™”ëœ ì±„íŒ…ë°©</h3>
        <div id="room-list">
            <p>í˜„ì¬ í™œì„±í™”ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
    </div>
    
    <div id="chat-area" style="display: none;">
        <ul id="messages"></ul>
        <form id="chat-form">
            <input id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (@ì±—ë´‡ ë‚´ìš©)" autocomplete="off"/>
            <button>ì „ì†¡</button>
        </form>
    </div>

    <div id="create-room-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h4>ë°© ë§Œë“¤ê¸°</h4>
            <form id="create-room-form">
                <p><input id="room-name-input" placeholder="ë°© ì´ë¦„" required style="width: 100%; padding: 8px; margin-bottom: 10px;"/></p>
                <p><label>ì •ì› (2~4ëª…):</label>
                <input id="max-users-input" type="number" min="2" max="4" value="2" required style="width: 50px; padding: 8px; margin-bottom: 10px;"/></p>
                <p><label><input type="checkbox" id="use-password-checkbox"/> ë¹„ë°€ë²ˆí˜¸ ì‚¬ìš©</label></p>
                <p><input id="room-password-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" disabled style="width: 100%; padding: 8px; margin-bottom: 10px;"/></p>
                <button type="submit" class="btn" style="width: 100%;">ë°© ìƒì„± í›„ ì…ì¥</button>
            </form>
        </div>
    </div>
    
    <div id="join-room-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h4 id="join-room-title">ë°© ì…ì¥</h4>
            <form id="join-room-form">
                <input id="current-joining-room" type="hidden" />
                <p><input id="join-nickname-input" placeholder="ì‚¬ìš©í•  ë‹‰ë„¤ì„" required style="width: 100%; padding: 8px; margin-bottom: 10px;"/></p>
                <p id="join-password-area" style="display: none;">
                    <input id="join-password-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" style="width: 100%; padding: 8px; margin-bottom: 10px;"/>
                </p>
                <button type="submit" class="btn" style="width: 100%;">ì…ì¥í•˜ê¸°</button>
            </form>
        </div>
    </div>


    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // ğŸ’¡ ì „ì—­ ìƒíƒœ ë³€ìˆ˜
        let currentRoomName = null;
        let myNickname = null;
        
        // HTML ìš”ì†Œ ì •ì˜
        const roomTitle = document.getElementById('room-title');
        const userCountArea = document.getElementById('user-count-area');
        const mainContent = document.getElementById('main-content');
        const roomListDiv = document.getElementById('room-list');
        const createRoomBtn = document.getElementById('create-room-btn');
        const chatArea = document.getElementById('chat-area');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const messages = document.getElementById('messages');
        
        // ëª¨ë‹¬ ìš”ì†Œ ì •ì˜
        const createRoomModal = document.getElementById('create-room-modal');
        const joinRoomModal = document.getElementById('join-room-modal');
        const joinRoomTitle = document.getElementById('join-room-title');
        const createRoomForm = document.getElementById('create-room-form');
        const joinRoomForm = document.getElementById('join-room-form');
        const usePasswordCheckbox = document.getElementById('use-password-checkbox');
        const roomPasswordInput = document.getElementById('room-password-input');
        const joinPasswordArea = document.getElementById('join-password-area');
        const joinPasswordInput = document.getElementById('join-password-input');
        const joinNicknameInput = document.getElementById('join-nickname-input');
        const currentJoiningRoom = document.getElementById('current-joining-room');
        
        let chatbotWaitingMessage = null; 
        let waitingAnimationInterval = null; 

        // --- í—¬í¼ í•¨ìˆ˜ ---
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        function addSystemMessage(data) {
            const item = document.createElement('li');
            item.textContent = `[ì‹œìŠ¤í…œ] ${data.text}`; 
            item.style.color = 'gray';
            item.style.textAlign = 'center';
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        }
        
        function startWaitingAnimation() {
             if (waitingAnimationInterval) {
                clearInterval(waitingAnimationInterval);
            }
            const waitingDiv = document.getElementById('waiting-text');
            if (!waitingDiv) return;

            let dotCount = 1;
            waitingAnimationInterval = setInterval(() => {
                dotCount = (dotCount % 3) + 1; 
                const dots = '.'.repeat(dotCount);
                waitingDiv.innerHTML = `ì‘ë‹µ ëŒ€ê¸°ì¤‘${dots}`;
            }, 300);
        }
        
        function hideAllModals() {
            createRoomModal.style.display = 'none';
            joinRoomModal.style.display = 'none';
        }
        
        // ë°© ëª©ë¡ì—ì„œ íŠ¹ì • ë°©ì„ í´ë¦­í–ˆì„ ë•Œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
        function attemptJoinRoom(roomName, hasPassword) {
            joinRoomTitle.textContent = `ë°© ì…ì¥: ${roomName}`;
            currentJoiningRoom.value = roomName;
            
            // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì°½ í‘œì‹œ/ìˆ¨ê¹€
            if (hasPassword) {
                joinPasswordArea.style.display = 'block';
                joinPasswordInput.required = true;
            } else {
                joinPasswordArea.style.display = 'none';
                joinPasswordInput.required = false;
                joinPasswordInput.value = ''; // ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”
            }
            
            // ëª¨ë‹¬ ì—´ê¸°
            joinRoomModal.style.display = 'block';
            joinNicknameInput.focus();
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        
        // 1. ë°© ë§Œë“¤ê¸° ë²„íŠ¼ í´ë¦­
        createRoomBtn.addEventListener('click', () => {
            hideAllModals();
            createRoomModal.style.display = 'block';
            document.getElementById('room-name-input').focus();
        });
        
        // 1-1. ë¹„ë°€ë²ˆí˜¸ ì²´í¬ë°•ìŠ¤ í† ê¸€
        usePasswordCheckbox.addEventListener('change', (e) => {
            roomPasswordInput.disabled = !e.target.checked;
            roomPasswordInput.required = e.target.checked;
            if (!e.target.checked) roomPasswordInput.value = '';
        });
        
        // 1-2. ë°© ë§Œë“¤ê¸° í¼ ì œì¶œ (ì„œë²„ë¡œ 'create room' ì „ì†¡)
        createRoomForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const roomName = document.getElementById('room-name-input').value.trim();
            const maxUsers = parseInt(document.getElementById('max-users-input').value, 10);
            const usePassword = usePasswordCheckbox.checked;
            const password = usePassword ? roomPasswordInput.value.trim() : null;
            
            // ë°© ìƒì„± ì‹œì—ëŠ” ë‹‰ë„¤ì„ ì…ë ¥ì´ ë”°ë¡œ ì—†ìœ¼ë¯€ë¡œ, ê¸°ë³¸ê°’(ë¡œë¹„ì—ì„œ ì…ë ¥)ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
            // ğŸ’¡ ì—¬ê¸°ì„œëŠ” ë‹‰ë„¤ì„ ì…ë ¥ì„ JoinRoomModalì—ì„œ í†µì¼í•˜ë„ë¡ ë¡œì§ì„ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
            //    -> ë°© ìƒì„± í›„ ë°”ë¡œ ë‹‰ë„¤ì„ ëª¨ë‹¬ì„ ì—´ë„ë¡ ë³€ê²½ (ìƒˆë¡œìš´ êµ¬ì¡°ì— ë§ê²Œ)
            
            // ë‹‰ë„¤ì„ì„ ë¡œë¹„ì—ì„œ ì…ë ¥í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ë°© ìƒì„± í›„ ë°”ë¡œ ë‹‰ë„¤ì„ ì…ë ¥ ëª¨ë‹¬ì„ ë„ìš°ê³ ,
            // ë‹‰ë„¤ì„ ì…ë ¥ í›„ ì„œë²„ì˜ 'create room' ë˜ëŠ” 'join room' ë¡œì§ì„ ì‹¤í–‰í•˜ë„ë¡ ë³€ê²½í•©ë‹ˆë‹¤.
            
            hideAllModals();
            attemptJoinRoom(roomName, usePassword); // ë°©ì„ ìƒì„±í•˜ì§€ë§Œ, ì‹¤ì œ ì„œë²„ í†µì‹ ì€ join-room-formì—ì„œ ìˆ˜í–‰
            
        });
        
        // 2. ë°© ì…ì¥ í¼ ì œì¶œ (ì„œë²„ë¡œ 'join room' ë˜ëŠ” 'create room' ì „ì†¡)
        joinRoomForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const roomName = currentJoiningRoom.value;
            const nickname = joinNicknameInput.value.trim();
            const password = joinPasswordInput.value.value || null;
            
            // ğŸ’¡ ì„œë²„ì— ë°©ì´ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” ë¡œì§ì´ í•„ìš”í•©ë‹ˆë‹¤.
            //    (í´ë¼ì´ì–¸íŠ¸ì—ì„œëŠ” ë°© ëª©ë¡ì„ ë³´ê³  ì…ì¥í•˜ë¯€ë¡œ 'join room'ìœ¼ë¡œ í†µì¼)
            
            // --- í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œì˜ ë°© ìƒì„±/ì…ì¥ í†µì¼ ë¡œì§ ---
            const isCreating = !!document.getElementById('room-name-input').value.trim() && !document.getElementById('current-joining-room').value; // ì´ í”Œë˜ê·¸ëŠ” ë³µì¡í•˜ë‹ˆ, ì„œë²„ ì‘ë‹µì— ë”°ë¼ ì²˜ë¦¬í•˜ë„ë¡ ë³€ê²½í•©ë‹ˆë‹¤.
            
            // ì„œë²„ì— 'join room' ìš”ì²­ (ì„œë²„ì—ì„œ ë°© ìœ ë¬´ ë° ì •ì›, ë¹„ë°€ë²ˆí˜¸ë¥¼ ì²´í¬)
            socket.emit('join room', { roomName, password, nickname }, (response) => {
                if (response.success) {
                    currentRoomName = response.roomName;
                    myNickname = nickname;
                    
                    hideAllModals();
                    mainContent.style.display = 'none';
                    chatArea.style.display = 'block';
                    messages.innerHTML = '';
                    
                    roomTitle.textContent = `ì±„íŒ…ë°©: ${currentRoomName}`;
                    
                    // ë‹‰ë„¤ì„ ë“±ë¡ ì„±ê³µ ì‹œ ë³¸ì¸ì˜ ì ‘ì† ì•Œë¦¼ì„ ìŠ¤ìŠ¤ë¡œ í‘œì‹œ
                    // ì„œë²„ì—ì„œ ì „ì†¡í•˜ëŠ” ì‹œìŠ¤í…œ ë©”ì‹œì§€ì™€ ì¤‘ë³µë˜ë¯€ë¡œ, ì„œë²„ ë©”ì‹œì§€ë¥¼ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
                    // addSystemMessage({ text: `${myNickname}ë‹˜ì´ ì ‘ì†í–ˆìŠµë‹ˆë‹¤.` });
                    
                    chatInput.focus();
                } else {
                    alert(response.reason);
                }
            });
            
        });
        
        // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ ì²˜ë¦¬
        document.querySelectorAll('.close').forEach(span => {
            span.onclick = () => hideAllModals();
        });
        
        window.onclick = (event) => {
            if (event.target === createRoomModal || event.target === joinRoomModal) {
                hideAllModals();
            }
        };

        // 3. ì±„íŒ… ë©”ì‹œì§€ ì œì¶œ ì²˜ë¦¬
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = chatInput.value.trim();
            const now = Date.now();
            
            if (message && currentRoomName && myNickname) {
                socket.emit('chat message', message); 

                // 1. ì‚¬ìš©ì ë³¸ì¸ì˜ ë©”ì‹œì§€ë¥¼ ì¦‰ì‹œ í™”ë©´ì— í‘œì‹œ
                const timeString = formatTime(now);
                
                const userItem = document.createElement('li');
                userItem.innerHTML = `
                    <span class="user-nickname">${myNickname}</span>
                    <span class="chat-message-time">(${timeString})</span>
                    <div>${message}</div>
                `;
                messages.appendChild(userItem);
                
                
                // 2. ì±—ë´‡ í˜¸ì¶œì´ ìˆë‹¤ë©´ ì‘ë‹µ ëŒ€ê¸° ë©”ì‹œì§€ë¥¼ ë°”ë¡œ ë’¤ì— ì¶”ê°€
                if (message.startsWith('@ì±—ë´‡')) {
                    const waitingItem = document.createElement('li');
                    waitingItem.classList.add('chatbot-message'); 
                    
                    waitingItem.innerHTML = `
                        <span class="chatbot-nickname">Gemini ì±—ë´‡</span>
                        <span class="chat-message-time">(${timeString})</span>
                        <div id="waiting-text">ì‘ë‹µ ëŒ€ê¸°ì¤‘.</div> 
                        `;
                    
                    messages.appendChild(waitingItem);
                    
                    chatbotWaitingMessage = waitingItem;
                    
                    startWaitingAnimation(); 
                    chatInput.disabled = true; 
                }

                window.scrollTo(0, document.body.scrollHeight);
                chatInput.value = '';
            }
        });

        // 4. ë©”ì‹œì§€ ìˆ˜ì‹  ë° í‘œì‹œ
        socket.on('chat message', (data) => {
            // A. ì±—ë´‡ ì‘ë‹µ ë„ì°© ì‹œ ëŒ€ê¸° ë©”ì‹œì§€ ì œê±° ë° ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
            if (data.nickname === 'Gemini ì±—ë´‡' && chatbotWaitingMessage) {
                if (waitingAnimationInterval) {
                    clearInterval(waitingAnimationInterval);
                    waitingAnimationInterval = null;
                }

                messages.removeChild(chatbotWaitingMessage);
                chatbotWaitingMessage = null; 
                chatInput.disabled = false;
            }
            
            // B. ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì²˜ë¦¬
            if (data.nickname === '[ì‹œìŠ¤í…œ]') {
                addSystemMessage(data);
                return;
            }

            // C. ì‚¬ìš©ì ë³¸ì¸ì´ ë³´ë‚¸ ë©”ì‹œì§€(ì—ì½”)ëŠ” ì´ë¯¸ í™”ë©´ì— í‘œì‹œë˜ì—ˆìœ¼ë¯€ë¡œ ê±´ë„ˆëœë‹ˆë‹¤.
            if (data.nickname === myNickname) {
                return; 
            }
            
            // D. ì±—ë´‡ ì‘ë‹µì´ë‚˜ ë‹¤ë¥¸ ì‚¬ìš©ì ë©”ì‹œì§€ ì²˜ë¦¬
            const timeString = formatTime(data.timestamp);
            const item = document.createElement('li');
            
            let nicknameClass = 'user-nickname';
            
            if (data.nickname === 'Gemini ì±—ë´‡') {
                item.classList.add('chatbot-message');
                nicknameClass = 'chatbot-nickname';
            }
            
            item.innerHTML = `
                <span class="${nicknameClass}">${data.nickname}</span>
                <span class="chat-message-time">(${timeString})</span>
                <div>${data.text}</div>
            `;
            
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        });

        // 5. ë°© ëª©ë¡ ì—…ë°ì´íŠ¸
        socket.on('update room list', (roomList) => {
            roomListDiv.innerHTML = ''; // ëª©ë¡ ì´ˆê¸°í™”

            if (roomList.length === 0) {
                roomListDiv.innerHTML = '<p>í˜„ì¬ í™œì„±í™”ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            roomList.forEach(room => {
                const item = document.createElement('div');
                item.className = 'room-item';
                item.setAttribute('data-room-name', room.name);
                item.onclick = () => attemptJoinRoom(room.name, room.hasPassword); // í´ë¦­ ì´ë²¤íŠ¸ ì„¤ì •
                
                const lockIcon = room.hasPassword ? ' ğŸ”’' : '';
                
                item.innerHTML = `
                    <div class="room-info">${room.name}${lockIcon}</div>
                    <div class="room-status">${room.current}/${room.max}ëª…</div>
                `;
                roomListDiv.appendChild(item);
            });
        });

        // 6. í˜„ì¬ ë°© ì ‘ì†ì ìˆ˜ ì—…ë°ì´íŠ¸
        socket.on('update room user count', (countString) => {
            userCountArea.textContent = `ì ‘ì† ì¸ì›: ${countString}`; 
        });
        
        // ì´ˆê¸° ì ‘ì† ì‹œ ë°© ëª©ë¡ ìš”ì²­ (connect ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ëŠ” ë‹¨ìˆœí™”)
        socket.on('connect', () => {
            console.log('Socket connected. Requesting room list...');
        });
    </script>
</body>
</html>