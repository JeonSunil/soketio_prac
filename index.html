<!DOCTYPE html>
<html>
<head>
    <title>Gemini ì±—ë´‡ ì±„íŒ… (2ëª… ì •ì›)</title>
    <style>
        /* ğŸ’¡ CSS ìŠ¤íƒ€ì¼ ì‹œíŠ¸ ë¸”ë¡ ì¶”ê°€ */
        body { 
            margin: 0; 
            padding-bottom: 70px; /* ê³ ì • í•˜ë‹¨ í¼ ê³µê°„ í™•ë³´ */
            font-family: sans-serif; 
            background-color: #f7f7f7;
        }
        #messages { 
            margin: 0; 
            padding: 10px; 
            list-style-type: none; 
        }
        #messages li { 
            margin-bottom: 10px; 
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            line-height: 1.4;
        }
        .chat-message-time {
            color: gray; 
            font-size: 0.75em;
            margin-left: 5px;
        }
        /* ì±—ë´‡ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ ì •ì˜ */
        .chatbot-message {
            background-color: #e8eaf6; /* ì—°í•œ íŒŒë‘ ë°°ê²½ */
            border-left: 4px solid #3f51b5; /* ì§„í•œ íŒŒë‘ ë§‰ëŒ€ */
        }
        .chatbot-nickname {
            color: #3f51b5; /* ë‹‰ë„¤ì„ ìƒ‰ìƒ */
            font-weight: bold;
        }
        .user-nickname {
            font-weight: bold;
            color: #333;
        }
        #chat-form {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: #ffffff;
            padding: 10px;
            box-sizing: border-box;
            border-top: 1px solid #ddd;
            display: flex;
        }
        #chat-input {
            flex-grow: 1;
            padding: 10px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #chat-form button {
            padding: 10px 15px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="user-count-area" style="text-align: center; font-weight: bold; padding: 10px; border-bottom: 1px solid #ccc; background-color: #fff;">
        ì ‘ì† ì¸ì›: <span id="user-count">0/2</span>
    </div>
    
    <div id="nickname-area" style="padding: 20px; text-align: center;">
        <form id="nickname-form">
            <input id="nickname-input" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off" required style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;"/>
            <button style="padding: 8px 15px;">ì±„íŒ…ë°© ì…ì¥</button>
        </form>
    </div>

    <div id="chat-area" style="display: none;">
        <ul id="messages"></ul>
        <form id="chat-form">
            <input id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (@ì±—ë´‡ ë‚´ìš©)" autocomplete="off"/>
            <button>ì „ì†¡</button>
        </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // HTML ìš”ì†Œ ì •ì˜
        const userCountDisplay = document.getElementById('user-count');
        const nicknameArea = document.getElementById('nickname-area');
        const nicknameForm = document.getElementById('nickname-form');
        const nicknameInput = document.getElementById('nickname-input');
        const chatArea = document.getElementById('chat-area');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const messages = document.getElementById('messages');
        let chatbotWaitingMessage = null; 
        let waitingAnimationInterval = null; 

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // ğŸš€ ìƒˆë¡œìš´ í•¨ìˆ˜ ì¶”ê°€: ì‹œìŠ¤í…œ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶”ê°€í•˜ëŠ” ë„ìš°ë¯¸ í•¨ìˆ˜
        function addSystemMessage(message) {
            const item = document.createElement('li');
            item.textContent = `[ì‹œìŠ¤í…œ] ${message}`; 
            item.style.color = 'gray';
            item.style.textAlign = 'center';
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        }

        // --- ì‘ë‹µ ëŒ€ê¸° ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜ (ìƒëµë˜ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ìœ ì§€) ---
        function startWaitingAnimation() {
            if (waitingAnimationInterval) {
                clearInterval(waitingAnimationInterval);
            }
            const waitingDiv = document.getElementById('waiting-text');
            if (!waitingDiv) return;

            let dotCount = 1;
            waitingAnimationInterval = setInterval(() => {
                dotCount = (dotCount % 3) + 1; 
                const dots = '.'.repeat(dotCount);
                waitingDiv.innerHTML = `ì‘ë‹µ ëŒ€ê¸°ì¤‘${dots}`;
            }, 300);
        }
        // ---

        // 0. ì†Œì¼“ ì—°ê²° ì‹œ ì²˜ë¦¬ (í™”ë©´ ì´ˆê¸°í™”)
        socket.on('connect', () => {
            console.log('Socket connected.');
            messages.innerHTML = '';
        });


        // 1. ë‹‰ë„¤ì„ ì œì¶œ ì²˜ë¦¬ (ìˆ˜ì • ë¶€ë¶„)
        nicknameForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const nickname = nicknameInput.value.trim();
            if (nickname) {
                socket.emit('new user', nickname, (response) => {
                    if (response.success) {
                        nicknameArea.style.display = 'none';
                        chatArea.style.display = 'block';
                        chatInput.focus();
                        messages.innerHTML = '';
                        
                        // ğŸš€ í•µì‹¬ ìˆ˜ì •: ë‹‰ë„¤ì„ ë“±ë¡ ì„±ê³µ ì‹œ ë³¸ì¸ì˜ ì ‘ì† ì•Œë¦¼ì„ ìŠ¤ìŠ¤ë¡œ í‘œì‹œ
                        addSystemMessage(`${nickname}ë‹˜ì´ ì ‘ì†í–ˆìŠµë‹ˆë‹¤.`); 

                    } else {
                        alert(response.reason);
                    }
                });
            }
        });

        // 2. ì±„íŒ… ë©”ì‹œì§€ ì œì¶œ ì²˜ë¦¬ ìˆ˜ì • (ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ ë¡œì§ ì¶”ê°€)
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = chatInput.value.trim();
            const now = Date.now();
            
            if (message) {
                socket.emit('chat message', message); 

                // 1. ì‚¬ìš©ì ë³¸ì¸ì˜ ë©”ì‹œì§€ë¥¼ ì¦‰ì‹œ í™”ë©´ì— í‘œì‹œ
                const userNickname = nicknameInput.value; 
                const timeString = formatTime(now);
                
                const userItem = document.createElement('li');
                userItem.innerHTML = `
                    <span class="user-nickname">${userNickname}</span>
                    <span class="chat-message-time">(${timeString})</span>
                    <div>${message}</div>
                `;
                messages.appendChild(userItem);
                
                
                // 2. ì±—ë´‡ í˜¸ì¶œì´ ìˆë‹¤ë©´ ì‘ë‹µ ëŒ€ê¸° ë©”ì‹œì§€ë¥¼ ë°”ë¡œ ë’¤ì— ì¶”ê°€
                if (message.startsWith('@ì±—ë´‡')) {
                    const waitingItem = document.createElement('li');
                    waitingItem.classList.add('chatbot-message'); 
                    
                    waitingItem.innerHTML = `
                        <span class="chatbot-nickname">Gemini ì±—ë´‡</span>
                        <span class="chat-message-time">(${timeString})</span>
                        <div id="waiting-text">ì‘ë‹µ ëŒ€ê¸°ì¤‘.</div> 
                        `;
                    
                    messages.appendChild(waitingItem);
                    
                    chatbotWaitingMessage = waitingItem;
                    
                    startWaitingAnimation(); 
                    chatInput.disabled = true; 
                }

                window.scrollTo(0, document.body.scrollHeight);
                chatInput.value = '';
            }
        });

        // 3. ë©”ì‹œì§€ ìˆ˜ì‹  ë° í‘œì‹œ ìˆ˜ì • (ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€ ë¡œì§ ì¶”ê°€)
        socket.on('chat message', (data) => {
            const userNickname = nicknameInput.value; 

            // A. ì±—ë´‡ ì‘ë‹µì´ ë„ì°©í•˜ë©´ ëŒ€ê¸° ë©”ì‹œì§€ ì œê±° ë° ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
            if (data.nickname === 'Gemini ì±—ë´‡' && chatbotWaitingMessage) {
                if (waitingAnimationInterval) {
                    clearInterval(waitingAnimationInterval);
                    waitingAnimationInterval = null;
                }

                messages.removeChild(chatbotWaitingMessage);
                chatbotWaitingMessage = null; 
                chatInput.disabled = false;
            }

            // B. ì‚¬ìš©ì ë³¸ì¸ì´ ë³´ë‚¸ ë©”ì‹œì§€(ì—ì½”)ëŠ” ì´ë¯¸ í™”ë©´ì— í‘œì‹œë˜ì—ˆìœ¼ë¯€ë¡œ ê±´ë„ˆëœë‹ˆë‹¤.
            if (data.nickname === userNickname) {
                return; 
            }
            
            // C. ì±—ë´‡ ì‘ë‹µì´ë‚˜ ë‹¤ë¥¸ ì‚¬ìš©ì ë©”ì‹œì§€ë§Œ ì²˜ë¦¬
            const timeString = formatTime(data.timestamp);
            const item = document.createElement('li');
            
            let nicknameClass = 'user-nickname';
            
            if (data.nickname === 'Gemini ì±—ë´‡') {
                item.classList.add('chatbot-message');
                nicknameClass = 'chatbot-nickname';
            }
            
            item.innerHTML = `
                <span class="${nicknameClass}">${data.nickname}</span>
                <span class="chat-message-time">(${timeString})</span>
                <div>${data.text}</div>
            `;
            
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        });

        // 4. ì‹œìŠ¤í…œ ì•Œë¦¼ (ì ‘ì†/í‡´ì¥) ìˆ˜ì‹  (addSystemMessage ì‚¬ìš©)
        socket.on('user notification', (message) => {
            // ğŸš€ addSystemMessage í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì•Œë¦¼ì„ í‘œì‹œ
            addSystemMessage(message); 
        });

        // 5. ì ‘ì†ì ìˆ˜ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
        socket.on('update user count', (countString) => {
            userCountDisplay.textContent = countString; 
        });
    </script>
</body>
</html>