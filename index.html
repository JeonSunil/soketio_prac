<!DOCTYPE html>
<html>
<head>
    <title>Socket.IO Chat (2ëª… ì •ì›)</title>
</head>
<body>
    <div id="user-count-area" style="text-align: center; font-weight: bold; padding: 10px; border-bottom: 1px solid #ccc;">
        ì ‘ì† ì¸ì›: <span id="user-count">0/2</span>
    </div>
    
    <div id="nickname-area" style="padding: 20px;">
        <form id="nickname-form">
            <input id="nickname-input" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off" required />
            <button>ì±„íŒ…ë°© ì…ì¥</button>
        </form>
    </div>

    <div id="chat-area" style="display: none;">
        <ul id="messages" style="margin: 0; padding: 0 10px 50px 10px; list-style-type: none;"></ul>
        <form id="chat-form" style="position: fixed; bottom: 0; width: 100%; background: #f1f1f1; padding: 10px;">
            <input id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off" style="width: calc(100% - 70px); padding: 8px; margin-right: 5px;"/>
            <button>ì „ì†¡</button>
        </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // HTML ìš”ì†Œ ì •ì˜
        const userCountDisplay = document.getElementById('user-count');
        const nicknameArea = document.getElementById('nickname-area');
        const nicknameForm = document.getElementById('nickname-form');
        const nicknameInput = document.getElementById('nickname-input');
        const chatArea = document.getElementById('chat-area');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const messages = document.getElementById('messages');

        // ì‹œê°„ í¬ë§·íŒ… í•¨ìˆ˜
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // 1. ë‹‰ë„¤ì„ ì œì¶œ ì²˜ë¦¬
        nicknameForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const nickname = nicknameInput.value.trim();
            if (nickname) {
                socket.emit('new user', nickname, (response) => {
                    if (response.success) {
                        // ì„±ê³µ ì‹œ í™”ë©´ ì „í™˜
                        nicknameArea.style.display = 'none';
                        chatArea.style.display = 'block';
                        chatInput.focus();
                    } else {
                        // ì‹¤íŒ¨ ì‹œ (ì •ì› ì´ˆê³¼ ë“±) ì•Œë¦¼
                        alert(response.reason);
                    }
                });
            }
        });

        // 2. ì±„íŒ… ë©”ì‹œì§€ ì œì¶œ ì²˜ë¦¬
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (chatInput.value) {
                socket.emit('chat message', chatInput.value); 
                chatInput.value = '';
            }
        });

        // 3. ë©”ì‹œì§€ ìˆ˜ì‹  ë° í‘œì‹œ (ì‹œê°„ í¬ë§· ë° ì±—ë´‡ êµ¬ë¶„)
        socket.on('chat message', (data) => {
            const timeString = formatTime(data.timestamp);
            const item = document.createElement('li');
            
            let nicknameStyle = 'font-weight: bold;';
            
            // ğŸš¨ ì±—ë´‡ ë©”ì‹œì§€ ì‹œê°ì  êµ¬ë¶„
            if (data.nickname === 'Gemini ì±—ë´‡') {
                nicknameStyle += 'color: #3f51b5;'; // íŒŒë€ìƒ‰ ê³„ì—´
                item.style.backgroundColor = '#e8eaf6'; 
                item.style.borderLeft = '4px solid #3f51b5';
            }
            
            item.style.padding = '5px 10px';

            item.innerHTML = `
                <span style="${nicknameStyle}">${data.nickname}</span>
                <span style="color: gray; font-size: 0.8em;">(${timeString})</span>
                <div>${data.text}</div>
            `;
            
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        });

        // 4. ì‹œìŠ¤í…œ ì•Œë¦¼ (ì ‘ì†/í‡´ì¥) ìˆ˜ì‹ 
        socket.on('user notification', (message) => {
            const item = document.createElement('li');
            item.textContent = `[ì‹œìŠ¤í…œ] ${message}`; 
            item.style.color = 'gray';
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        });

        // 5. ì ‘ì†ì ìˆ˜ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
        socket.on('update user count', (countString) => {
            userCountDisplay.textContent = countString; 
        });
    </script>
</body>
</html>