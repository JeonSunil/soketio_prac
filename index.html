<!DOCTYPE html>
<html>
<head>
    <title>Gemini ë©€í‹° ì±„íŒ…ë°©</title>
    <style>
        body { 
            margin: 0; 
            padding-bottom: 70px; /* ì…ë ¥ í¼ ê³µê°„ í™•ë³´ */
            font-family: sans-serif; 
            background-color: #f7f7f7;
            display: flex; 
            flex-direction: column;
            min-height: 100vh;
        }
        header {
            background-color: #3f51b5;
            color: white;
            padding: 15px;
            text-align: center;
            flex-shrink: 0;
            z-index: 10;
        }
        #main-content {
            padding: 20px;
            flex-grow: 1; 
            flex-shrink: 0;
        }
        
        /* ì±„íŒ… ë ˆì´ì•„ì›ƒ ìŠ¤íƒ€ì¼ */
        #chat-container {
            display: none; 
            flex-grow: 1;
            overflow: hidden;
        }
        #user-list-sidebar {
            width: 200px;
            background-color: #e3f2fd;
            padding: 10px;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            flex-shrink: 0;
            height: calc(100vh - 50px); 
        }
        #user-list-sidebar h4 {
            margin-top: 0;
            color: #3f51b5;
            margin-bottom: 10px;
        }
        .user-list-item {
            padding: 5px;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            border-bottom: 1px dotted #ccc;
        }
        .user-list-item:hover {
            background-color: #c5e1a5;
        }
        .user-list-item .ready-status {
            font-size: 0.8em;
            margin-left: 5px;
            font-weight: bold;
        }
        .host-label {
            color: gold; 
            font-weight: bold;
            margin-left: 5px;
        }
        .user-list-item[data-is-host="true"] {
            border: 1px solid gold;
        }

        #chat-main-content {
            flex-grow: 1;
            overflow-y: hidden;
            height: calc(100vh - 50px);
            position: relative;
        }
        
        /* ì±„íŒ… ì˜ì—­ êµ¬ë¶„ */
        .chat-room {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            padding: 10px;
            padding-bottom: 60px; 
            display: none; 
        }
        #lobby-chat-area { display: block; }
        
        #messages, #game-messages { 
            margin: 0; 
            padding: 0;
            list-style-type: none; 
        }
        #messages li, #game-messages li { 
            margin-bottom: 10px; 
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            line-height: 1.4;
        }
        
        .chat-message-time {
            color: gray; 
            font-size: 0.75em;
            margin-left: 5px;
        }
        .chatbot-message {
            background-color: #e8eaf6; 
            border-left: 4px solid #3f51b5; 
        }
        .chatbot-nickname {
            color: #3f51b5; 
            font-weight: bold;
        }
        .user-nickname {
            font-weight: bold;
            color: #333;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #game-start-btn, #game-ready-btn {
            padding: 10px 15px;
            border: none;
            background-color: #28a745;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            display: none; 
            flex-shrink: 0;
        }
        #game-ready-btn.ready {
            background-color: #ffc107; 
        }
        
        #chat-form {
            /* ğŸš© ê¸°ë³¸ displayëŠ” JSì—ì„œ 'none'ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤. */
            position: fixed;
            bottom: 0;
            width: 100%; 
            left: 0;     
            right: 0;    
            background: #ffffff;
            padding: 10px;
            box-sizing: border-box;
            border-top: 1px solid #ddd;
            display: none; /* ğŸš© ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¸°ë˜, JSì—ì„œ 'flex'ë¡œ ë³€ê²½ */
            align-items: center; 
            z-index: 10; 
        }
        #chat-input {
            flex-grow: 1;
            padding: 10px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* ê²Œì„ í™œì„±í™” ìƒíƒœ ìŠ¤íƒ€ì¼ */
        body.game-active #main-content {
            display: none;
        }
        body.game-active #chat-container {
            display: flex;
            height: calc(100vh - 50px);
        }
        body.game-active #chat-form {
            width: calc(100% - 200px); 
            left: 200px;
            display: flex; /* ê²Œì„ ì¤‘ì—ëŠ” ë°˜ë“œì‹œ í‘œì‹œ */
        }
        body.game-active #lobby-chat-area {
            display: none;
        }
        body.game-active #game-chat-area {
            display: block;
        }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none; 
            position: fixed;
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover, .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .room-item {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            cursor: pointer;
            background-color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .room-item:hover {
            background-color: #eee;
        }
        .room-info {
            font-weight: bold;
        }
        .room-status {
            font-size: 0.9em;
            color: #555;
        }
    </style>
</head>
<body>
    <header>
        <div id="room-header">
            <span id="room-title">Gemini ë©€í‹° ì±„íŒ…ë°© ë¡œë¹„</span> 
            <span id="user-count-area" style="float: right; font-size: 0.9em;"></span>
        </div>
    </header>

    <div id="main-content">
        <button id="create-room-btn" class="btn">ë°© ë§Œë“¤ê¸°</button>
        <h3>í˜„ì¬ í™œì„±í™”ëœ ì±„íŒ…ë°©</h3>
        <div id="room-list">
            <p>í˜„ì¬ í™œì„±í™”ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
    </div>
    
    <div id="chat-container">
        <div id="user-list-sidebar">
            <h4>ì ‘ì† ìœ ì €</h4>
            <div id="current-user-list"></div>
        </div>
        
        <div id="chat-main-content">
            <div id="lobby-chat-area" class="chat-room">
                <ul id="messages"></ul>
            </div>
            
            <div id="game-chat-area" class="chat-room">
                <ul id="game-messages"></ul>
            </div>
        </div>
    </div>
    
    <form id="chat-form">
        <button id="game-start-btn">ê²Œì„ ì‹œì‘</button>
        <button id="game-ready-btn" data-ready="false">ê²Œì„ ì¤€ë¹„</button>
        <input id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (@ì±—ë´‡ ë‚´ìš©)" autocomplete="off"/>
        <button>ì „ì†¡</button>
    </form>


    <div id="create-room-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h4>ë°© ë§Œë“¤ê¸°</h4>
            <form id="create-room-form">
                <p><input id="room-name-input" placeholder="ë°© ì´ë¦„" required style="width: 100%; padding: 8px; margin-bottom: 10px;"/></p>
                <p><label>ì •ì› (2~4ëª…):</label>
                <input id="max-users-input" type="number" min="2" max="4" value="2" required style="width: 50px; padding: 8px; margin-bottom: 10px;"/></p>
                <p><label><input type="checkbox" id="use-password-checkbox"/> ë¹„ë°€ë²ˆí˜¸ ì‚¬ìš©</label></p>
                <p><input id="room-password-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" disabled style="width: 100%; padding: 8px; margin-bottom: 10px;"/></p>
                <button type="submit" class="btn" style="width: 100%;">ë°© ìƒì„±</button>
            </form>
        </div>
    </div>
    
    <div id="password-check-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h4 id="check-room-title">ë°© ë¹„ë°€ë²ˆí˜¸ í™•ì¸</h4>
            <form id="password-check-form">
                <input id="check-room-name" type="hidden" />
                <p id="check-password-area">
                    <input id="check-password-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" required style="width: 100%; padding: 8px; margin-bottom: 10px;"/>
                </p>
                <button type="submit" class="btn" style="width: 100%;">í™•ì¸</button>
            </form>
        </div>
    </div>
    
    <div id="nickname-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h4 id="nickname-room-title"></h4>
            <form id="nickname-form">
                <input id="final-room-name" type="hidden" />
                <p><input id="final-nickname-input" placeholder="ì‚¬ìš©í•  ë‹‰ë„¤ì„" required style="width: 100%; padding: 8px; margin-bottom: 10px;"/></p>
                <button type="submit" class="btn" style="width: 100%;">ì±„íŒ…ë°© ì§„ì…</button>
            </form>
        </div>
    </div>


    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // ğŸ’¡ ì „ì—­ ìƒíƒœ ë³€ìˆ˜
        let currentRoomName = null;
        let myNickname = null;
        let isHost = false; 
        
        // HTML ìš”ì†Œ ì •ì˜
        const roomTitle = document.getElementById('room-title');
        const userCountArea = document.getElementById('user-count-area');
        const mainContent = document.getElementById('main-content');
        const roomListDiv = document.getElementById('room-list');
        const createRoomBtn = document.getElementById('create-room-btn');
        
        const chatContainer = document.getElementById('chat-container'); 
        const userListSidebar = document.getElementById('user-list-sidebar'); 
        const currentUserList = document.getElementById('current-user-list'); 
        const chatMainContent = document.getElementById('chat-main-content'); 
        
        const lobbyChatArea = document.getElementById('lobby-chat-area'); 
        const gameChatArea = document.getElementById('game-chat-area'); 

        const chatForm = document.getElementById('chat-form'); // í¼ ìš”ì†Œ
        const chatInput = document.getElementById('chat-input');
        const messages = document.getElementById('messages'); 
        const gameMessages = document.getElementById('game-messages'); 

        const gameStartBtn = document.getElementById('game-start-btn');
        const gameReadyBtn = document.getElementById('game-ready-btn');

        // ëª¨ë‹¬ ìš”ì†Œ ì •ì˜
        const createRoomModal = document.getElementById('create-room-modal');
        const passwordCheckModal = document.getElementById('password-check-modal');
        const nicknameModal = document.getElementById('nickname-modal');
        
        const createRoomForm = document.getElementById('create-room-form');
        const passwordCheckForm = document.getElementById('password-check-form');
        const nicknameForm = document.getElementById('nickname-form');
        
        const usePasswordCheckbox = document.getElementById('use-password-checkbox');
        const roomPasswordInput = document.getElementById('room-password-input');

        const checkRoomTitle = document.getElementById('check-room-title');
        const checkRoomName = document.getElementById('check-room-name');
        const checkPasswordArea = document.getElementById('check-password-area');
        const checkPasswordInput = document.getElementById('check-password-input');
        
        const nicknameRoomTitle = document.getElementById('nickname-room-title');
        const finalRoomName = document.getElementById('final-room-name');
        const finalNicknameInput = document.getElementById('final-nickname-input');
        
        let chatbotWaitingMessage = null; 
        let waitingAnimationInterval = null; 

        // --- í—¬í¼ í•¨ìˆ˜ ---
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        function addSystemMessage(data, targetList = messages) { 
            const item = document.createElement('li');
            item.textContent = `${data.nickname} ${data.text}`; 
            item.style.color = 'gray';
            item.style.textAlign = 'center';
            targetList.appendChild(item);
            targetList.scrollTop = targetList.scrollHeight;
        }
        
        function startWaitingAnimation() {
             if (waitingAnimationInterval) {
                clearInterval(waitingAnimationInterval);
            }
            const activeChatArea = document.body.classList.contains('game-active') ? gameMessages : messages;
            const waitingDiv = activeChatArea.querySelector('#waiting-text');
            if (!waitingDiv) return;

            let dotCount = 1;
            waitingAnimationInterval = setInterval(() => {
                dotCount = (dotCount % 3) + 1; 
                const dots = '.'.repeat(dotCount);
                waitingDiv.innerHTML = `ì‘ë‹µ ëŒ€ê¸°ì¤‘${dots}`;
            }, 300);
        }
        
        function hideAllModals() {
            createRoomModal.style.display = 'none';
            passwordCheckModal.style.display = 'none';
            nicknameModal.style.display = 'none';
        }

        function showNicknameModal(roomName, titleText) {
            hideAllModals();
            nicknameRoomTitle.textContent = titleText;
            finalRoomName.value = roomName;
            finalNicknameInput.value = ''; 
            nicknameModal.style.display = 'block';
            finalNicknameInput.focus();
        }
        
        function updateHostDelegation(targetSocketId, targetNickname) {
             if (isHost && targetSocketId !== socket.id) {
                if (confirm(`ì •ë§ë¡œ ${targetNickname}ë‹˜ì—ê²Œ ë°©ì¥ ê¶Œí•œì„ ìœ„ì„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    socket.emit('delegate host', targetSocketId);
                }
             }
        }
        
        function updateBottomButtons(hostStatus) {
            isHost = hostStatus;
            gameStartBtn.style.display = isHost ? 'block' : 'none';
            gameReadyBtn.style.display = isHost ? 'none' : 'block';
            
            if (isHost === false) { 
                gameReadyBtn.textContent = 'ê²Œì„ ì¤€ë¹„';
                gameReadyBtn.classList.remove('ready');
                gameReadyBtn.setAttribute('data-ready', 'false');
            }
        }
        
        function enterGamePhase(message) {
            document.body.classList.add('game-active');
            addSystemMessage({ nickname: '[ì‹œìŠ¤í…œ]', text: message }, gameMessages);
            gameMessages.innerHTML = ''; 
        }

        function exitGamePhase(message) {
            document.body.classList.remove('game-active');
            addSystemMessage({ nickname: '[ì‹œìŠ¤í…œ]', text: message }, messages);
        }
        
        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        
        // 0. ì†Œì¼“ ì—°ê²° ì‹œ ì²˜ë¦¬ (ë¡œë¹„ ìƒíƒœ ì´ˆê¸°í™”)
        socket.on('connect', () => {
            console.log('Socket connected.');
            if (!currentRoomName) { 
                mainContent.style.display = 'block';
                chatContainer.style.display = 'none';
                roomTitle.textContent = 'Gemini ë©€í‹° ì±„íŒ…ë°© ë¡œë¹„';
                userCountArea.textContent = '';
                updateBottomButtons(false); 
                hideAllModals(); 
                
                chatForm.style.display = 'none'; // ğŸš© ë¡œë¹„ ìƒíƒœì¼ ë•Œ í¼ ìˆ¨ê¸°ê¸°
            }
        });

        // 1. ë°© ë§Œë“¤ê¸° ë²„íŠ¼ í´ë¦­
        createRoomBtn.addEventListener('click', () => {
            hideAllModals();
            createRoomModal.style.display = 'block';
            document.getElementById('room-name-input').focus();
        });
        
        // 1-1. ë¹„ë°€ë²ˆí˜¸ ì²´í¬ë°•ìŠ¤ í† ê¸€
        usePasswordCheckbox.addEventListener('change', (e) => {
            roomPasswordInput.disabled = !e.target.checked;
            roomPasswordInput.required = e.target.checked;
            if (!e.target.checked) roomPasswordInput.value = '';
        });
        
        // 1-2. ë°© ë§Œë“¤ê¸° í¼ ì œì¶œ
        createRoomForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const roomName = document.getElementById('room-name-input').value.trim();
            const maxUsers = parseInt(document.getElementById('max-users-input').value, 10);
            const usePassword = usePasswordCheckbox.checked;
            const password = usePassword ? roomPasswordInput.value.trim() : null;
            
            socket.emit('create room', { roomName, maxUsers, password }, (response) => {
                if (response.success) {
                    showNicknameModal(roomName, `ë°© ìƒì„± ì™„ë£Œ: ${roomName}`);
                } else {
                    alert(response.reason);
                }
            });
        });
        
        // 2. ë°© ëª©ë¡ì—ì„œ ë°© í´ë¦­ ì‹œ
        function attemptJoinRoom(roomName, hasPassword) {
            hideAllModals();
            
            if (hasPassword) {
                checkRoomTitle.textContent = `ë°© ì…ì¥: ${roomName}`;
                checkRoomName.value = roomName;
                checkPasswordArea.style.display = 'block';
                checkPasswordInput.required = true;
                checkPasswordInput.value = ''; 
                passwordCheckModal.style.display = 'block';
                checkPasswordInput.focus();
            } else {
                showNicknameModal(roomName, `ë°© ì…ì¥: ${roomName}`);
            }
        }
        
        // 3. ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í¼ ì œì¶œ
        passwordCheckForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const roomName = checkRoomName.value;
            const password = checkPasswordInput.value.trim();
            
            socket.emit('check join room', { roomName, password }, (response) => {
                if (response.success) {
                    showNicknameModal(roomName, `ë°© ì…ì¥: ${roomName}`);
                } else {
                    alert(response.reason);
                }
            });
        });
        
        // 4. ë‹‰ë„¤ì„ ì…ë ¥ í¼ ì œì¶œ (ë°© ì…ì¥ ì„±ê³µ ì‹œ)
        nicknameForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const roomName = finalRoomName.value;
            const nickname = finalNicknameInput.value.trim();
            
            if (nickname.length === 0) {
                alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            socket.emit('enter room', { roomName, nickname }, (response) => {
                if (response.success) {
                    currentRoomName = response.roomName;
                    myNickname = nickname;
                    
                    hideAllModals();
                    mainContent.style.display = 'none';
                    chatContainer.style.display = 'flex';
                    
                    document.body.classList.remove('game-active');
                    lobbyChatArea.style.display = 'block'; 
                    gameChatArea.style.display = 'none';
                    
                    messages.innerHTML = '';
                    gameMessages.innerHTML = '';
                    
                    roomTitle.textContent = `ì±„íŒ…ë°©: ${currentRoomName}`;
                    chatInput.focus();
                    
                    updateBottomButtons(response.isHost);
                    
                    chatForm.style.display = 'flex'; // ğŸš© ë°© ì…ì¥ ì„±ê³µ ì‹œ í¼ í‘œì‹œ

                    if (response.isHost) {
                        addSystemMessage({ nickname: '[ì‹œìŠ¤í…œ]', text: 'ğŸ‰ ë°©ì¥ ê¶Œí•œì´ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤. ê²Œì„ ì‹œì‘ ë²„íŠ¼ì´ í‘œì‹œë©ë‹ˆë‹¤.' });
                    }

                } else {
                    alert(response.reason);
                }
            });
        });
        
        // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸
        document.querySelectorAll('.close').forEach(span => {
            span.onclick = () => hideAllModals();
        });
        
        window.onclick = (event) => {
            if (event.target === createRoomModal || event.target === passwordCheckModal || event.target === nicknameModal) {
                hideAllModals();
            }
        };

        // 5. ê²Œì„ ì‹œì‘ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
        gameStartBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (isHost) {
                socket.emit('start game');
            } else {
                alert("ê²Œì„ ì‹œì‘ ê¶Œí•œì€ ë°©ì¥ì—ê²Œë§Œ ìˆìŠµë‹ˆë‹¤.");
            }
        });

        // 6. ê²Œì„ ì¤€ë¹„ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
        gameReadyBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (!isHost) {
                socket.emit('toggle ready');
            }
        });
        
        // 7. ì±„íŒ… ë©”ì‹œì§€ ì œì¶œ ì²˜ë¦¬
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = chatInput.value.trim();
            const now = Date.now();
            
            if (message && currentRoomName && myNickname) {
                socket.emit('chat message', message); 

                const targetList = document.body.classList.contains('game-active') ? gameMessages : messages;
                const timeString = formatTime(now);
                
                const userItem = document.createElement('li');
                userItem.innerHTML = `
                    <span class="user-nickname">${myNickname}</span>
                    <span class="chat-message-time">(${timeString})</span>
                    <div>${message}</div>
                `;
                targetList.appendChild(userItem);
                
                
                if (message.startsWith('@ì±—ë´‡')) {
                    const waitingItem = document.createElement('li');
                    waitingItem.classList.add('chatbot-message'); 
                    waitingItem.innerHTML = `
                        <span class="chatbot-nickname">Gemini ì±—ë´‡</span>
                        <span class="chat-message-time">(${timeString})</span>
                        <div id="waiting-text">ì‘ë‹µ ëŒ€ê¸°ì¤‘.</div> 
                        `;
                    targetList.appendChild(waitingItem);
                    chatbotWaitingMessage = waitingItem;
                    startWaitingAnimation(); 
                    chatInput.disabled = true; 
                }

                targetList.scrollTop = targetList.scrollHeight;
                chatInput.value = '';
            }
        });

        // 8. ë©”ì‹œì§€ ìˆ˜ì‹  ë° í‘œì‹œ
        socket.on('chat message', (data) => {
            const targetList = document.body.classList.contains('game-active') ? gameMessages : messages;
            
            if (data.nickname === 'Gemini ì±—ë´‡' && chatbotWaitingMessage) {
                if (waitingAnimationInterval) {
                    clearInterval(waitingAnimationInterval);
                    waitingAnimationInterval = null;
                }
                
                const timeString = formatTime(data.timestamp);
                chatbotWaitingMessage.innerHTML = `
                    <span class="chatbot-nickname">Gemini ì±—ë´‡</span>
                    <span class="chat-message-time">(${timeString})</span>
                    <div>${data.text}</div>
                `;
                chatbotWaitingMessage.classList.remove('chatbot-message');
                chatbotWaitingMessage = null; 
                chatInput.disabled = false;
                
                targetList.scrollTop = targetList.scrollHeight;
                return;
            }
            
            if (data.nickname === '[ì‹œìŠ¤í…œ]') {
                addSystemMessage(data, targetList);
                return;
            }

            if (data.nickname === myNickname) {
                return; 
            }
            
            const timeString = formatTime(data.timestamp);
            const item = document.createElement('li');
            
            let nicknameClass = 'user-nickname';
            
            if (data.nickname === 'Gemini ì±—ë´‡') {
                item.classList.add('chatbot-message');
                nicknameClass = 'chatbot-nickname';
            }
            
            item.innerHTML = `
                <span class="${nicknameClass}">${data.nickname}</span>
                <span class="chat-message-time">(${timeString})</span>
                <div>${data.text}</div>
            `;
            
            targetList.appendChild(item);
            targetList.scrollTop = targetList.scrollHeight;
        });
        
        // 9. ìœ ì € ëª©ë¡ ì—…ë°ì´íŠ¸
        socket.on('update user list', (userList) => {
            currentUserList.innerHTML = '';
            
            userList.forEach(user => {
                const item = document.createElement('div');
                item.id = user.id; 
                item.className = 'user-list-item';
                item.setAttribute('data-is-host', user.isHost);
                item.setAttribute('data-is-ready', user.isReady);
                
                if (isHost && user.id !== socket.id) {
                    item.title = `${user.nickname}ì—ê²Œ ë°©ì¥ ê¶Œí•œ ìœ„ì„ (í´ë¦­)`;
                    item.onclick = () => updateHostDelegation(user.id, user.nickname);
                } else if (!isHost && user.id !== socket.id) {
                    item.title = 'í´ë¦­í•˜ì—¬ ìœ ì € ì •ë³´ ë³´ê¸°';
                }

                let statusLabel = '';
                if (user.isHost) {
                    statusLabel = '<span class="host-label">[ë°©ì¥]</span>';
                } else if (user.isReady) {
                    statusLabel = '<span class="ready-status" style="color:#28a745;">[ì¤€ë¹„]</span>';
                } else if (!user.isHost) {
                     statusLabel = '<span class="ready-status" style="color:#dc3545;">[ëŒ€ê¸°]</span>';
                }

                item.innerHTML = `
                    <span style="font-weight: bold;">${user.nickname}</span>
                    ${statusLabel}
                `;
                currentUserList.appendChild(item);
            });
        });
        
        // 10. ë°©ì¥ ê¶Œí•œ ë³€ê²½ ì•Œë¦¼
        socket.on('host change', (newHostStatus) => {
            updateBottomButtons(newHostStatus);
        });
        
        // 11. ê²Œì„ ì‹œì‘ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
        socket.on('game phase start', (data) => {
            enterGamePhase(data.message);
        });

        // 12. ë°© ëª©ë¡ ì—…ë°ì´íŠ¸
        socket.on('update room list', (roomList) => {
            roomListDiv.innerHTML = ''; 

            if (roomList.length === 0) {
                roomListDiv.innerHTML = '<p>í˜„ì¬ í™œì„±í™”ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            roomList.forEach(room => {
                const item = document.createElement('div');
                item.className = 'room-item';
                item.setAttribute('data-room-name', room.name);
                item.onclick = () => attemptJoinRoom(room.name, room.hasPassword); 
                
                const lockIcon = room.hasPassword ? ' ğŸ”’' : '';
                
                item.innerHTML = `
                    <div class="room-info">${room.name}${lockIcon}</div>
                    <div class="room-status">${room.current}/${room.max}ëª…</div>
                `;
                roomListDiv.appendChild(item);
            });
        });

        // 13. í˜„ì¬ ë°© ì ‘ì†ì ìˆ˜ ì—…ë°ì´íŠ¸
        socket.on('update room user count', (countString) => {
            userCountArea.textContent = `ì ‘ì† ì¸ì›: ${countString}`; 
        });
    </script>
</body>
</html>